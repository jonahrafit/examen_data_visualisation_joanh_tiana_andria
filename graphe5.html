<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Radar Chart - Analyse des pannes par météo</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 30px; }
  .axis line, .axis circle {
    stroke: #999;
    stroke-width: 1px;
    fill: none;
  }
  .area {
    fill: steelblue;
    fill-opacity: 0.5;
  }
  .axis-label {
    font-size: 12px;
    font-weight: bold;
    fill: #333;
  }
  .tooltip {
    position: absolute;
    background-color: white;
    border: 1px solid #ccc;
    padding: 4px 8px;
    font-size: 12px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s;
  }
</style>
</head>
<body>

<h2>Radar Chart - Analyse des pannes par météo</h2>
<svg width="600" height="600"></svg>

<div class="tooltip" id="tooltip"></div>

<script>
const svg = d3.select("svg"),
      width = +svg.attr("width"),
      height = +svg.attr("height"),
      margin = 60,
      radius = Math.min(width, height) / 2 - margin;

const g = svg.append("g")
  .attr("transform", `translate(${width/2},${height/2})`);

const tooltip = d3.select("#tooltip");

d3.csv("transmada_data_500_with_date.csv").then(data => {
  const pannesParMeteo = d3.rollups(
    data,
    v => v.filter(d => d.Panne === "Oui").length,
    d => d.Météo
  );

  const categories = pannesParMeteo.map(d => d[0]);
  const values = pannesParMeteo.map(d => d[1]);
  const maxValue = d3.max(values);

  const angleSlice = (2 * Math.PI) / categories.length;

  // Echelle radiale (distance du centre)
  const rScale = d3.scaleLinear()
    .range([0, radius])
    .domain([0, maxValue]);

  // Axe circulaire concentriques
  const levels = 5;
  for(let level = 1; level <= levels; level++) {
    const rLevel = radius / levels * level;
    g.append("circle")
      .attr("r", rLevel)
      .attr("fill", "none")
      .attr("stroke", "#CDCDCD")
      .attr("stroke-dasharray", "2,2");
    
    // Label de l’échelle
    g.append("text")
      .attr("x", 4)
      .attr("y", -rLevel)
      .attr("font-size", "10px")
      .attr("fill", "#777")
      .text(Math.round(maxValue * level / levels));
  }

  // Axes radiaux (lignes)
  const axis = g.selectAll(".axis")
    .data(categories)
    .enter()
    .append("g")
    .attr("class", "axis");

  axis.append("line")
    .attr("x1", 0)
    .attr("y1", 0)
    .attr("x2", (d,i) => rScale(maxValue * 1.1) * Math.cos(angleSlice * i - Math.PI/2))
    .attr("y2", (d,i) => rScale(maxValue * 1.1) * Math.sin(angleSlice * i - Math.PI/2))
    .attr("stroke", "grey")
    .attr("stroke-width", "1px");

  axis.append("text")
    .attr("class", "axis-label")
    .attr("x", (d,i) => rScale(maxValue * 1.2) * Math.cos(angleSlice * i - Math.PI/2))
    .attr("y", (d,i) => rScale(maxValue * 1.2) * Math.sin(angleSlice * i - Math.PI/2))
    .attr("text-anchor", "middle")
    .attr("dy", "0.35em")
    .text(d => d);

  // Préparer les points pour la zone
  const radarLine = d3.lineRadial()
    .radius(d => rScale(d.value))
    .angle((d,i) => i * angleSlice)
    .curve(d3.curveLinearClosed);

  const radarData = pannesParMeteo.map((d,i) => ({axis: d[0], value: d[1]}));

  // Dessiner la zone radar
  g.append("path")
    .datum(radarData)
    .attr("class", "area")
    .attr("d", radarLine)
    .attr("fill", "steelblue")
    .attr("fill-opacity", 0.5)
    .attr("stroke", "steelblue")
    .attr("stroke-width", 2);

  // Dessiner les points et tooltip
  g.selectAll(".radarCircle")
    .data(radarData)
    .enter()
    .append("circle")
    .attr("class", "radarCircle")
    .attr("r", 5)
    .attr("cx", (d,i) => rScale(d.value) * Math.cos(angleSlice * i - Math.PI/2))
    .attr("cy", (d,i) => rScale(d.value) * Math.sin(angleSlice * i - Math.PI/2))
    .attr("fill", "steelblue")
    .attr("stroke", "#fff")
    .attr("stroke-width", 2)
    .on("mouseover", function(event, d) {
      tooltip.style("opacity", 1)
             .html(`<strong>${d.axis}</strong><br/>Pannes: ${d.value}`)
             .style("left", (event.pageX + 10) + "px")
             .style("top", (event.pageY - 28) + "px");
      d3.select(this).attr("r", 8);
    })
    .on("mouseout", function() {
      tooltip.style("opacity", 0);
      d3.select(this).attr("r", 5);
    });
});
</script>

</body>
</html>
